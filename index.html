<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IR T.V - Modern Layout</title>
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* General Styling & Reset */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern font */
            background-color: #121212; /* Deep dark background */
            color: #E0E0E0; /* Soft white text */
        }

        /* Variables for easy color management */
        :root {
            --primary-bg: #1A1A1A;
            --secondary-bg: #222222;
            --tertiary-bg: #2C2C2C;
            --accent-blue: #007BFF;
            --accent-blue-hover: #0056b3;
            --accent-green: #00C853; /* For positive indicators/titles */
            --accent-red: #FF4444; /* For negative indicators/alerts */
            --border-color: #333333;
            --text-light: #E0E0E0;
            --text-medium: #BBBBBB;
            --text-dark: #888888;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.4);
            --shadow-strong: rgba(0, 0, 0, 0.6);
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --control-panel-bg: rgba(30, 30, 30, 0.85); /* For floating controls */
        }

        /* Layout Structure */
        .background {
            display: flex;
            flex-direction: row;
            height: 100%;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            box-shadow: inset 0 0 15px var(--shadow-medium);
        }

        .main-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--primary-bg);
            transition: width var(--transition-speed) ease-in-out;
        }

        .order-book-layout {
            width: 0; /* Initially hidden */
            min-width: 0;
            background-color: var(--secondary-bg);
            border-left: 1px solid var(--border-color);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: width var(--transition-speed) ease-in-out;
            box-shadow: -3px 0 10px var(--shadow-medium);
            padding: 20px;
        }
        .order-book-layout.visible {
            width: 30%;
        }

        .order-book-layout h2 {
            font-size: 1.6em;
            color: var(--accent-blue);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            text-align: center;
        }
        .order-book-layout ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .order-book-layout li {
            background-color: var(--tertiary-bg);
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: background-color var(--transition-speed) ease;
        }
        .order-book-layout li:hover {
            background-color: #383838;
        }
        .order-book-layout li span:first-child {
            font-weight: bold;
        }
        .order-book-layout li span:nth-child(2) {
            font-weight: bold;
        }

        .chart-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--primary-bg);
            overflow: hidden;
            position: relative;
            padding: 15px;
            box-sizing: border-box;
            transition: width var(--transition-speed) ease-in-out;
        }

        .chart-area {
            background-color: var(--tertiary-bg);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            transition: height var(--transition-speed) ease-in-out, margin-bottom var(--transition-speed) ease-in-out;
            box-shadow: inset 0 0 10px var(--shadow-light);
            border: 1px solid var(--border-color);
            height: 100%;
        }
        .chart-area h2 {
            font-size: 2.5em;
            color: var(--text-dark);
            text-align: center;
            text-shadow: 2px 2px 5px var(--shadow-strong);
        }

        .volume-layout, .cdv-layout, .rsi-layout {
            height: 20%;
            min-height: 50px;
            background-color: var(--tertiary-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            margin-top: 15px;
            border-radius: var(--border-radius);
            box-shadow: inset 0 0 8px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all var(--transition-speed) ease-in-out;
            transform: translateY(0);
            opacity: 1;
        }
        .volume-layout h3, .cdv-layout h3, .rsi-layout h3 {
            margin-top: 0;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 1.2em;
        }
        .volume-layout p, .cdv-layout p, .rsi-layout p {
            font-size: 0.85em;
            color: var(--text-medium);
        }

        .floating-layout {
            position: absolute;
            top: 15px;
            left: 15px;
            width: fit-content;
            max-width: calc(100% - 30px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            overflow-x: auto;
            white-space: nowrap;
            padding: 2px;
            -ms-overflow-style: none;
            scrollbar-width: none;
            background-color: var(--control-panel-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px var(--shadow-strong);
            transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        .floating-layout::-webkit-scrollbar {
            height: 7px;
        }
        .floating-layout::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .floating-layout::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
        }
        .floating-layout::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue-hover);
        }

        .shadow-layout, .indicator-expand-layout {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 35px;
            padding: 0 15px;
            background: var(--tertiary-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px var(--shadow-light);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            font-weight: 700;
            font-size: 15px;
            color: var(--text-light);
            flex-shrink: 0;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }
        .shadow-layout:hover, .indicator-expand-layout:hover {
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        .btn-desing-1 {
            cursor: pointer;
            font-weight: 700;
            color: var(--accent-blue);
            padding: 5px 10px;
            border-radius: 6px;
            transition: background 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .btn-desing-1:hover {
            background: rgba(0, 123, 255, 0.15);
        }

        .btn-desing-2 {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 30px;
            padding: 0 12px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            background: var(--secondary-bg);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: transform 0.2s ease-in-out, background 0.2s ease-in-out, box-shadow 0.2s ease-in-out, color 0.2s ease-in-out;
            box-shadow: 0 2px 5px var(--shadow-light);
        }
        .btn-desing-2:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-medium);
            background: var(--tertiary-bg);
        }
        .btn-desing-2.active {
            background-color: var(--accent-blue) !important;
            color: white !important;
            box-shadow: 0 3px 8px var(--accent-blue);
            transform: translateY(-1px);
        }
        .btn-desing-2 img {
            filter: invert(100%) brightness(1.5);
            transition: transform 0.2s ease;
        }
        .indicator-expand-btn.active img {
            transform: rotate(180deg);
        }

        .hidden {
            height: 0 !important;
            min-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            border: none !important;
            opacity: 0 !important;
            transform: translateY(20px);
            pointer-events: none;
            overflow: hidden !important;
        }

        .hidden-completely {
            display: none !important;
        }
        
        /* New: for hiding order book content */
        .order-book-layout.hidden-content {
            padding-left: 0;
            padding-right: 0;
            border: none;
            box-shadow: none;
            opacity: 0;
        }

        /* Adjust chart area margin if indicators are present */
        .chart-layout:not(.no-indicator-margin) .chart-area {
            margin-bottom: 15px;
        }
        .chart-layout.no-indicator-margin .chart-area {
            margin-bottom: 0;
        }

        /* New styling for the chart container */
        .chart-container {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="background">
        <div class="main-layout">
            <div class="chart-layout" id="chartLayout">
                <div class="chart-area" id="mainChartArea">
                    <div class="chart-container" id="chart-container"></div>
                </div>

                <div class="floating-layout">
                    <div class="shadow-layout" id="btcusdt-layout">BTCUSDT
                        <div class="btn-desing-1" id="preview-tf">5M</div>
                    </div>
                    <div class="shadow-layout hidden-completely" id="timeframe-layout">
                        <div class="btn-desing-2" id="btn-1m">1M</div>
                        <div class="btn-desing-2 active" id="btn-5m">5M</div>
                        <div class="btn-desing-2" id="btn-15m">15M</div>
                        <div class="btn-desing-2" id="btn-30m">30M</div>
                        <div class="btn-desing-2" id="btn-1h">1H</div>
                        <div class="btn-desing-2" id="btn-2h">2H</div>
                        <div class="btn-desing-2" id="btn-4h">4H</div>
                        <div class="btn-desing-2" id="btn-1d">1D</div>
                    </div>
                    <div class="indicator-expand-layout">
                        <div class="btn-desing-2" id="indicator-expand-btn">
                            <img src="https://cdn-icons-png.flaticon.com/512/271/271228.png" alt="Expand" style="width:14px; height:14px;" />
                        </div>
                    </div>
                    <div class="shadow-layout hidden-completely" id="indicator-layout">
                        <div class="btn-desing-2" id="volume-btn">VOL</div>
                        <div class="btn-desing-2" id="cdv-btn">CDV</div>
                        <div class="btn-desing-2" id="rsi-btn">RSI</div>
                        <div class="btn-desing-2" id="order-book-btn">OB</div>
                    </div>
                </div>

                <div class="volume-layout hidden" id="volume-layout1">
                    <h3>Volume Profile</h3>
                    <p>Analysis of trading volume over price.</p>
                </div>
                <div class="cdv-layout hidden" id="cdv-layout1">
                    <h3>Cumulative Delta Volume</h3>
                    <p>Net difference between buy and sell volume.</p>
                </div>
                <div class="rsi-layout hidden" id="rsi-layout1">
                    <h3>Relative Strength Index</h3>
                    <p>Measures the speed and change of price movements.</p>
                </div>
            </div>
        </div>
        <div class="order-book-layout" id="order-book-layout1">
            <h2>Order Book</h2>
            <p style="text-align: center; color: var(--text-dark); margin-bottom: 20px;">Live market depth</p>
            <ul>
                <li><span>BUY</span> <span style="color: var(--accent-green);">100</span> @ <span>10.00</span></li>
                <li><span>SELL</span> <span style="color: var(--accent-red);">50</span> @ <span>10.05</span></li>
                <li><span>BUY</span> <span style="color: var(--accent-green);">200</span> @ <span>9.98</span></li>
                <li><span>SELL</span> <span style="color: var(--accent-red);">75</span> @ <span>10.07</span></li>
                <li><span>BUY</span> <span style="color: var(--accent-green);">150</span> @ <span>9.95</span></li>
                <li><span>SELL</span> <span style="color: var(--accent-red);">120</span> @ <span>10.10</span></li>
                <li><span>BUY</span> <span style="color: var(--accent-green);">80</span> @ <span>9.93</span></li>
                <li><span>SELL</span> <span style="color: var(--accent-red);">60</span> @ <span>10.12</span></li>
                <li><span>BUY</span> <span style="color: var(--accent-green);">110</span> @ <span>9.90</span></li>
                <li><span>SELL</span> <span style="color: var(--accent-red);">90</span> @ <span>10.15</span></li>
            </ul>
        </div>
    </div>

    <script>
        // Get references to elements
        const timeframeLayout = document.getElementById('timeframe-layout');
        const indicatorLayout = document.getElementById('indicator-layout');
        const mainLayout = document.querySelector('.main-layout');
        const chartLayout = document.getElementById('chartLayout');
        const mainChartArea = document.getElementById('mainChartArea');
        const chartContainer = document.getElementById('chart-container');
        const orderBookLayout = document.getElementById('order-book-layout1');
        const volumeLayout = document.getElementById('volume-layout1');
        const cdvLayout = document.getElementById('cdv-layout1');
        const rsiLayout = document.getElementById('rsi-layout1');
        const previewTf = document.getElementById('preview-tf');

        // Buttons
        const timeframeButtons = [
            document.getElementById('btn-1m'),
            document.getElementById('btn-5m'),
            document.getElementById('btn-15m'),
            document.getElementById('btn-30m'),
            document.getElementById('btn-1h'),
            document.getElementById('btn-2h'),
            document.getElementById('btn-4h'),
            document.getElementById('btn-1d')
        ];

        // WebSocket connection instance
        let ws;
        let chart;
        let candleSeries;
        let lastCandle;
        let currentInterval = '5m';
        let isLoading = false;

        // Function to toggle visibility using 'hidden-completely' for display:none
        function toggleDisplayLayout(buttonId, layoutElement) {
            document.getElementById(buttonId).addEventListener('click', function() {
                this.classList.toggle('active');
                layoutElement.classList.toggle('hidden-completely');
            });
        }

        toggleDisplayLayout('preview-tf', timeframeLayout);
        toggleDisplayLayout('indicator-expand-btn', indicatorLayout);

        // Define a map of triggers to their target elements
        const indicatorElements = {
            'volume-btn': volumeLayout,
            'cdv-btn': cdvLayout,
            'rsi-btn': rsiLayout
        };

        // Add event listeners for height changes
        for (const [triggerId, targetElement] of Object.entries(indicatorElements)) {
            const triggerEl = document.getElementById(triggerId);
            if (triggerEl && targetElement) {
                triggerEl.addEventListener('click', function() {
                    this.classList.toggle('active');
                    targetElement.classList.toggle('hidden');
                    updateChartHeight();
                });
            }
        }

        // Add event listener for the order book button (width change)
        const orderBookBtn = document.getElementById('order-book-btn');
        if (orderBookBtn) {
            orderBookBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                orderBookLayout.classList.toggle('visible');
                updateLayoutWidth();
            });
        }

        // --- Core Functions for Height and Width Adjustment ---

        function updateChartHeight() {
            const visibleIndicatorsCount = Object.values(indicatorElements).filter(el => !el.classList.contains('hidden')).length;
            const remainingHeight = 100 - (visibleIndicatorsCount * 20);
            
            // Apply the new height to the main chart area
            mainChartArea.style.height = `${remainingHeight}%`;

            // Adjust margin for chart area when indicators are visible/hidden
            if (visibleIndicatorsCount > 0) {
                chartLayout.classList.remove('no-indicator-margin');
            } else {
                chartLayout.classList.add('no-indicator-margin');
            }

            // Resize the chart itself to fit the new dimensions
            if (chart) {
                chart.resize(mainChartArea.offsetWidth, mainChartArea.offsetHeight);
            }
        }

        function updateLayoutWidth() {
            const isOrderBookVisible = orderBookLayout.classList.contains('visible');
            if (isOrderBookVisible) {
                mainLayout.style.width = '70%';
                orderBookLayout.style.width = '30%';
            } else {
                mainLayout.style.width = '100%';
                orderBookLayout.style.width = '0%';
            }

            // Resize the chart to fit the new width
            if (chart) {
                chart.resize(mainChartArea.offsetWidth, mainChartArea.offsetHeight);
            }
        }

        // --- Chart Initialization and Live Data with Smooth Animation ---
        
        // Custom function to format time to IST (12-hour format)
        function formatIST(timestamp) {
            const date = new Date(timestamp * 1000); // Convert Unix timestamp to milliseconds
            const options = {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata' // Set time zone to Indian Standard Time
            };
            return date.toLocaleString('en-US', options);
        }

        // Function to handle fetching and updating data
        function updateTimeframe(interval) {
            // Close existing WebSocket connection if it exists
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }

            currentInterval = interval;
            isLoading = false;

            // Update the preview button text
            previewTf.textContent = interval.toUpperCase();

            // Clear existing chart data
            if (candleSeries) {
                candleSeries.setData([]);
            }
            lastCandle = null;

            // Fetch initial historical data
            fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=1000`)
                .then(res => res.json())
                .then(data => {
                    const initialCandleData = data.map(k => ({
                        time: k[0] / 1000,
                        open: parseFloat(k[1]),
                        high: parseFloat(k[2]),
                        low: parseFloat(k[3]),
                        close: parseFloat(k[4]),
                    }));
                    if (candleSeries) {
                         candleSeries.setData(initialCandleData);
                         lastCandle = initialCandleData.slice(-1)[0];
                    }
                });

            // Establish new WebSocket connection for the selected interval
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${interval}`);
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const kline = data.k;

                if (kline) {
                    const currentTime = kline.t / 1000;
                    const newOpen = parseFloat(kline.o);
                    const newHigh = parseFloat(kline.h);
                    const newLow = parseFloat(kline.l);
                    const newClose = parseFloat(kline.c);

                    if (lastCandle && currentTime === lastCandle.time) {
                        lastCandle.high = Math.max(lastCandle.high, newHigh);
                        lastCandle.low = Math.min(lastCandle.low, newLow);
                        lastCandle.close = newClose;
                        candleSeries.update(lastCandle);
                    } else if (lastCandle && currentTime > lastCandle.time) {
                        const newCandle = {
                            time: currentTime,
                            open: newOpen,
                            high: newHigh,
                            low: newLow,
                            close: newClose,
                        };
                        candleSeries.update(newCandle);
                        lastCandle = newCandle;
                    } else if (!lastCandle) {
                        lastCandle = {
                            time: currentTime,
                            open: newOpen,
                            high: newHigh,
                            low: newLow,
                            close: newClose,
                        };
                        candleSeries.setData([lastCandle]);
                    }
                }
            };
        }

        async function fetchMoreData() {
            if (isLoading || !candleSeries) return;
            isLoading = true;

            const currentData = candleSeries.data();
            if (currentData.length === 0) {
                isLoading = false;
                return;
            }

            const oldestTime = currentData[0].time;
            const limit = 500; // Number of candles to fetch

            console.log(`Fetching more data before time: ${oldestTime}, interval: ${currentInterval}, limit: ${limit}`);

            const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${currentInterval}&endTime=${oldestTime * 1000}&limit=${limit}`;

            try {
                const response = await fetch(url);
                const newData = await response.json();
                const formattedNewData = newData.map(k => ({
                    time: k[0] / 1000,
                    open: parseFloat(k[1]),
                    high: parseFloat(k[2]),
                    low: parseFloat(k[3]),
                    close: parseFloat(k[4]),
                })).reverse(); // Reverse to append correctly

                if (formattedNewData.length > 0) {
                    // Combine old data and new data
                    const updatedData = [...formattedNewData, ...currentData];
                    candleSeries.setData(updatedData);
                    console.log(`Successfully loaded ${formattedNewData.length} more candles.`);
                } else {
                    console.log('No more historical data to load.');
                }
            } catch (error) {
                console.error('Error fetching more historical data:', error);
            } finally {
                isLoading = false;
            }
        }
        
        
        document.addEventListener('DOMContentLoaded', () => {
    // Initialize Lightweight Charts
    chart = LightweightCharts.createChart(chartContainer, {
        layout: {
            background: { color: 'transparent' },
            textColor: '#E0E0E0',
        },
        grid: {
            vertLines: { color: 'transparent' },
            horzLines: { color: 'transparent' },
        },
        rightPriceScale: {
            borderColor: '#333333',
        },
        timeScale: {
            borderColor: '#333333',
            timeVisible: true,
            secondsVisible: false,
            // Enable scroll to load
            barSpacing: 6,
            minBarSpacing: 0.5, // Changed to allow more squeezing/zooming in
            // Custom time formatter for IST
            tickMarkFormatter: (time) => formatIST(time)
        },
        
    });
// Apply Indian Standard Time formatter for the X-axis
chart.applyOptions({
    timeScale: {
        timeVisible: true,
        secondsVisible: false, // you don’t want seconds in your format
    },
    localization: {
        timeFormatter: (time) => {
            const utcMillis = time * 1000;
            const date = new Date(utcMillis);

            return date.toLocaleString("en-GB", {
                timeZone: "Asia/Kolkata",
                day: "2-digit",
                month: "short",   // gives "Aug"
                year: "2-digit",  // gives "25"
                hour: "2-digit",
                minute: "2-digit",
                hour12: true
            }).replace(",", ""); // remove the comma that en-GB adds
        }
    }
});
    // ... rest of the code remains the same

            candleSeries = chart.addCandlestickSeries({
                upColor: 'rgba(0, 200, 83, 1)',
                downColor: 'rgba(255, 68, 68, 1)',
                borderDownColor: 'rgba(255, 68, 68, 1)',
                borderUpColor: 'rgba(0, 200, 83, 1)',
                wickDownColor: 'rgba(255, 68, 68, 1)',
                wickUpColor: 'rgba(0, 200, 83, 1)',
            });
            
            // --- Timeframe Button Handlers ---
            timeframeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    timeframeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const interval = this.id.replace('btn-', '');
                    updateTimeframe(interval);
                });
            });

            // --- Lazy Loading Scroll Listener ---
            chart.timeScale().subscribeVisibleLogicalRangeChange(visibleRange => {
                if (visibleRange) {
                    const barsInfo = candleSeries.barsInLogicalRange(visibleRange);
                    // Check if we are near the beginning of the loaded data
                    if (barsInfo !== null && barsInfo.from <= 100) {
                        fetchMoreData();
                    }
                }
            });

            // Resize chart when the window or container size changes
            new ResizeObserver(() => {
                if (chart) {
                    chart.resize(mainChartArea.offsetWidth, mainChartArea.offsetHeight);
                }
            }).observe(mainChartArea);

            // Set initial state
            updateChartHeight();
            updateLayoutWidth();
            updateTimeframe('5m'); // Default to 5M
        });
    </script>
</body>
</html>
